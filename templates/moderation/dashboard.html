<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Moderation Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 24px;
        background: #111827;   /* dark slate */
        color: #e5e7eb;        /* soft light gray */
      }
      h1 { margin: 0 0 12px; }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        max-width: 1100px;
      }
      @media (min-width: 980px) {
        .grid {
          grid-template-columns: 1.1fr 0.9fr;
          align-items: start;
        }
      }

      .card {
        border: 1px solid #1f2937;
        border-radius: 12px;
        padding: 16px;
        background: #020617;   /* near-black, but not full black */
        box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      }

      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      input[type="text"] {
        flex: 1;
        min-width: 260px;
        padding: 10px;
        border: 1px solid #374151;
        border-radius: 8px;
        background: #030712;
        color: #e5e7eb;
      }

      input[type="file"] {
        flex: 1;
        min-width: 260px;
        color: #e5e7eb;
      }

      button {
        padding: 10px 16px;
        border: 0;
        border-radius: 8px;
        cursor: pointer;
      }
      button:disabled { opacity: 0.6; cursor: not-allowed; }

      .btn {
        background: #2563eb;   /* blue primary */
        color: #f9fafb;
      }
      .btn-allow { background: #16a34a; color: #f9fafb; }
      .btn-block { background: #dc2626; color: #f9fafb; }
      .btn-soft  { background: #4b5563; color: #e5e7eb; }

      .muted {
        color: #9ca3af;
        font-size: 12px;
      }

      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
      }
      .pill.ok  { background: #064e3b; color: #bbf7d0; }
      .pill.bad { background: #7f1d1d; color: #fecaca; }

      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        background: #111827;
        padding: 1px 4px;
        border-radius: 4px;
        color: #e5e7eb;
      }

      table { border-collapse: collapse; width: 100%; }
      th, td {
        text-align: left;
        padding: 8px 6px;
        border-bottom: 1px solid #1f2937;
        vertical-align: top;
        word-break: break-word;
      }

      .section-title {
        margin: 0 0 8px;
        font-size: 16px;
      }

      .spacer { height: 8px; }

      /* IL text display */
      .il-box {
        border: 1px solid #1f2937;
        background: #020617;
        border-radius: 10px;
        padding: 12px;
        white-space: pre-wrap;
        line-height: 1.35;
        min-height: 84px;
      }

      .kpi {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .kpi > div {
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 8px 10px;
        background: #030712;
        font-size: 12px;
      }
      .kpi b { font-size: 14px; }
    </style>

  </head>
  <body>
    <h1>Toxicity Moderation</h1>
    <p class="muted">
      SL scoring + simple human labeling loop (IL). Oldest-first for labeling.
    </p>

    <div class="grid">

      <!-- LEFT COLUMN -->
      <div>

        <!-- Single-text scoring (compare) -->
        <div class="card">
          <h3 class="section-title">Compare models on the same text</h3>

          <div class="row" style="align-items:flex-start;">
            <input id="text" type="text" placeholder="Type text to scoreâ€¦" />

            <div style="display:flex; flex-direction:column; gap:6px; min-width:240px;">
              <label><input type="checkbox" class="modelchk" value="sl_baseline" checked> SL baseline</label>
              <label><input type="checkbox" class="modelchk" value="sl_finetune"> SL finetune</label>
              <label><input type="checkbox" class="modelchk" value="sl_oracle"> SL oracle</label>
              <label><input type="checkbox" class="modelchk" value="il_iter_005" checked> IL iter_005</label>
            </div>

            <button class="btn" onclick="scoreMulti()">Score</button>
          </div>

          <div id="result" class="muted" style="margin-top:10px;"></div>

          <table style="margin-top:10px;">
            <thead>
              <tr>
                <th>Model</th>
                <th>p(toxic)</th>
                <th>Pred</th>
              </tr>
            </thead>
            <tbody id="compare_tbl"></tbody>
          </table>
        </div>

        <!-- Human labeling (IL) -->
        <div class="card">
          <h3 class="section-title">Human labeling (IL)</h3>
          <p class="muted" style="margin-top: -4px;">
            Oldest UNCERTAIN item first.
            Remaining: <b id="il_remaining">-</b>
          </p>

          <div id="il_text" class="il-box">Loadingâ€¦</div>

          <div class="kpi">
            <div>p(toxic)<br/><b id="il_score">-</b></div>
            <div>uncertainty<br/><b id="il_unc">-</b></div>
            <div>source<br/><b id="il_source">-</b></div>
            <div>id<br/><b id="il_id">-</b></div>
          </div>

          <div class="spacer"></div>

          <div class="row">
            <button class="btn-allow" onclick="ilDecide('ALLOW')">Allow (A)</button>
            <button class="btn-block" onclick="ilDecide('BLOCK')">Block (B)</button>
            <button class="btn-soft" onclick="ilNext()">Skip (S)</button>
          </div>

          <div id="il_status" class="muted" style="margin-top: 10px;"></div>
        </div>

      </div>

      <!-- RIGHT COLUMN -->
      <div>

        <!-- Recent SL queries -->
        <div class="card">
          <h3 class="section-title">Recent (this server process)</h3>
          <p class="muted" style="margin-top:-4px;">
            This list is your in-memory ring buffer (resets when server restarts).
          </p>
          <table>
            <thead>
              <tr>
                <th>Text</th>
                <th>p(toxic)</th>
                <th>Uncertainty</th>
                <th>Pred</th>
              </tr>
            </thead>
            <tbody id="history">
              {% for r in history %}
              <tr>
                <td>{{ r.text }}</td>
                <td>{{ r.p_toxic|floatformat:4 }}</td>
                <td>{{ r.uncertainty|floatformat:4 }}</td>
                <td>
                  {% if r.p_toxic >= 0.5 %}
                  <span class="pill bad">toxic</span>
                  {% else %}
                  <span class="pill ok">clean</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="muted">No queries yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <p class="muted" style="margin-top:10px;">
            Tip: Keyboard shortcuts in labeling: <code>A</code>=allow, <code>B</code>=block, <code>S</code>=skip.
          </p>
        </div>

      </div>
    </div>

    <script>
      // ---------- SL single scoring ----------
      async function scoreMulti() {
        const text = (document.getElementById("text").value || "").trim();
        const res = document.getElementById("result");
        const tbl = document.getElementById("compare_tbl");

        if (!text) { res.textContent = "Enter some text first."; return; }

        const selected = Array.from(document.querySelectorAll(".modelchk"))
          .filter(x => x.checked)
          .map(x => x.value);

        if (selected.length === 0) { res.textContent = "Select at least one model."; return; }

        res.textContent = "Scoringâ€¦";
        tbl.innerHTML = "";

        let r, j;
        try {
          r = await fetch("/api/moderation/score_multi", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ text, models: selected, max_len: 256 }),
          });
          j = await r.json();
        } catch (e) {
          res.textContent = "Network or parse error: " + e;
          return;
        }
        if (!r.ok) { res.textContent = "Error: " + (j.error || r.statusText); return; }

        res.textContent = "";

        for (const row of j.results) {
          const pred = row.p_toxic >= 0.5 ? "toxic" : "clean";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(row.model)}</td>
            <td>${Number(row.p_toxic).toFixed(4)}</td>
            <td><span class="pill ${pred === "toxic" ? "bad" : "ok"}">${pred}</span></td>
          `;
          tbl.appendChild(tr);
        }
      }

      // ---------- IL labeling ----------
      let currentIlItemId = null;

      async function ilNext() {
        setIlStatus("Loading next itemâ€¦");
        let r, j;
        try {
          r = await fetch("/api/moderation/il/next");
          j = await r.json();
        } catch (e) {
          setIlStatus("Network error: " + e);
          return;
        }

        document.getElementById("il_remaining").textContent = (j.remaining ?? "-");

        // (optional) add two new <b> elements in HTML, then:
        if (document.getElementById("il_remaining_review")) {
          document.getElementById("il_remaining_review").textContent = (j.remaining_review ?? "-");
        }
        if (document.getElementById("il_remaining_uncertain")) {
          document.getElementById("il_remaining_uncertain").textContent = (j.remaining_uncertain ?? "-");
        }
        if (!j.item) {
          currentIlItemId = null;
          document.getElementById("il_text").textContent = "No items left ðŸŽ‰";
          fillIlMeta(null);
          setIlStatus("");
          return;
        }

        currentIlItemId = j.item.id;
        document.getElementById("il_text").textContent = j.item.text;
        fillIlMeta(j.item);
        setIlStatus("");
      }

      async function ilDecide(action) {
        if (!currentIlItemId) {
          alert("No item loaded.");
          return;
        }

        setIlStatus("Saving decisionâ€¦");

        let r, j;
        try {
          r = await fetch("/api/moderation/il/decide", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ item_id: currentIlItemId, action }),
          });
          j = await r.json().catch(() => ({}));
        } catch (e) {
          setIlStatus("");
          alert("Network error: " + e);
          return;
        }

        if (!r.ok) {
          setIlStatus("");
          alert("Error: " + (j.error || r.statusText));
          return;
        }

        await ilNext();
      }

      function fillIlMeta(item) {
        const set = (id, v) => document.getElementById(id).textContent = v;

        if (!item) {
          set("il_score", "-");
          set("il_unc", "-");
          set("il_source", "-");
          set("il_id", "-");
          return;
        }

        set("il_score", (item.sl_score != null ? Number(item.sl_score).toFixed(4) : "-"));
        set("il_unc", (item.sl_uncertainty != null ? Number(item.sl_uncertainty).toFixed(4) : "-"));
        set("il_source", item.source || "-");
        set("il_id", String(item.id));

        set("il_il_score", item.il_score != null ? Number(item.il_score).toFixed(4) : "-");
        set("il_il_suggested", item.il_suggested_action || "-");
        set("il_sl_action", item.sl_action || "-");
        set("il_needs_review", item.needs_review ? "YES" : "no");
      }

      function setIlStatus(msg) {
        document.getElementById("il_status").textContent = msg;
      }

      // keyboard shortcuts: A allow, B block, S skip
      window.addEventListener("keydown", (e) => {
        if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;
        const k = (e.key || "").toLowerCase();
        if (k === "a") ilDecide("ALLOW");
        if (k === "b") ilDecide("BLOCK");
        if (k === "s") ilNext();
      });

      // small safety for history prepend
      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // auto-load IL item on page load
      window.addEventListener("load", ilNext);

    function setResult(msg) {
      const el = document.getElementById("result");
      if (!el) { console.warn("Missing #result"); return; }
      el.textContent = msg;
}
    </script>
  </body>
</html>
